import { NextResponse } from 'next/server';import { verifyDownloadToken } from '@/lib/sign';import path from 'path';import fs from 'fs/promises';
export async function GET(req: Request){const {searchParams}=new URL(req.url);const token=searchParams.get('token');if(!token)return NextResponse.json({error:'Token ausente'},{status:400});const payload:any=verifyDownloadToken(token);if(!payload||!payload.file)return NextResponse.json({error:'Token inválido'},{status:401});const filePath=path.join(process.cwd(),'private',payload.file);try{const data=await fs.readFile(filePath);const headers=new Headers({'Content-Type':'audio/mpeg','Content-Disposition':`attachment; filename="${payload.file}"`});return new NextResponse(data,{headers});}catch{return NextResponse.json({error:'Arquivo não encontrado'},{status:404});}}