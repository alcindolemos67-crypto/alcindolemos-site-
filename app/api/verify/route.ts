import { NextResponse } from 'next/server';import { signDownload } from '@/lib/sign';import products from '@/../products.json';
export async function GET(req: Request){try{const {searchParams}=new URL(req.url);const payment_id=searchParams.get('payment_id');if(!payment_id)return NextResponse.json({ok:false,error:'payment_id ausente'},{status:400});const MP_TOKEN=process.env.MP_ACCESS_TOKEN as string;const SITE_URL=process.env.SITE_URL as string;if(!MP_TOKEN||!SITE_URL)return NextResponse.json({ok:false,error:'Config ausente'},{status:500});const mercadopago=(await import('mercadopago')).default;mercadopago.configure({access_token:MP_TOKEN});const result=await mercadopago.payment.findById(Number(payment_id));const status=result.body.status;if(status!=='approved')return NextResponse.json({ok:false,error:'Pagamento nÃ£o aprovado.'},{status:400});const sku=result.body.additional_info?.items?.[0]?.id||result.body.order?.type||result.body.external_reference;const matched=(products as any[]).filter(p=>!sku||p.sku===sku);const items=matched.length?matched:(products as any[]);const links=items.map((p:any)=>{const token=signDownload({file:p.file,sku:p.sku});const href=`${SITE_URL}/api/download?token=${encodeURIComponent(token)}`;return {title:p.title,href};});return NextResponse.json({ok:true,links});}catch(e:any){return NextResponse.json({ok:false,error:e.message||'Erro ao verificar'},{status:500});}}